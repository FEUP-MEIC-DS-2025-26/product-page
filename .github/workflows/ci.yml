name: CI Pipeline (Build, Lint, Test, Security)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

    steps:
      # 1. Código
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. pnpm + Node
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'pnpm'

      # 3. Instalar dependências
      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # 4. Lint
      - name: Run Linters
        run: pnpm run lint

      # 5. Testes
      - name: Run Tests
        env:
          CI: 'true'
        run: pnpm run test

      # 6. Scan de vulnerabilidades
      - name: Run pnpm Audit (Security Scan)
        run: pnpm audit --prod
        # se quiseres que NÃO falhe o pipeline por warnings:
        # continue-on-error: true

      # 7. Build das imagens Docker (para garantir que os Dockerfiles não rebentam)

      - name: Build Docker image for mips_host
        run: docker build -f apps/mips_host/Dockerfile -t mips-host:latest .

      - name: Build Docker image for mips_product_page
        run: docker build -f apps/mips_product_page/Dockerfile -t mips-product-page:latest .

      - name: Build Docker image for mips_shopping_cart
        run: docker build -f apps/mips_shopping_cart/Dockerfile -t mips-shopping-cart:latest .

      # Se quiseres também testar o Dockerfile da raiz:
      # - name: Build Docker image for web (root Dockerfile)
      #   run: docker build -f Dockerfile -t mips-web:latest .
